// --- Home buttons ---
function updateHomeButtons(){
  if(selectedPlant){
    btnHealth.classList.remove('gray');
    btnHealth.disabled=false;
  } else {
    btnHealth.classList.add('gray');
    btnHealth.disabled=true;
  }
}

// Home buttons
btnSetup.addEventListener('click',()=>{
  suggestPanel.style.display='none';
  existingPanel.style.display='none';
  optSuggest.style.display='inline-flex';
  optAlready.style.display='inline-flex';
  showPage(setup);
});

btnHealth.addEventListener('click',()=>{
  if(!selectedPlant){ alert('No plant data!'); return;}
  showPage(monitor);
});

btnClearAll.addEventListener('click',()=>{
  localStorage.removeItem('plantName');
  plantName = null;
  selectedPlant = null;
  updateHomeButtons();
  alert('All data cleared.');
  showPage(home);
});

// --- Setup Logic ---
optSuggest.addEventListener('click',()=>{
  optAlready.style.display='none';
  suggestPanel.style.display='block';
  suggestDropdown.innerHTML = '';
  const temp = parseFloat(s_temp.textContent)||25;
  const hum = parseFloat(s_hum.textContent)||50;
  const suggested = getSuggestedPlants(temp,hum);
  if(suggested.length===0){
    const opt = document.createElement('option');
    opt.value='';
    opt.textContent='No plants match sensor data';
    suggestDropdown.appendChild(opt);
  } else {
    suggested.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p.name;
      opt.textContent = p.name;
      suggestDropdown.appendChild(opt);
    });
  }
});

backFromSuggest.addEventListener('click',()=>{
  suggestPanel.style.display='none';
  optAlready.style.display='inline-flex';
});

optAlready.addEventListener('click',()=>{
  optSuggest.style.display='none';
  existingPanel.style.display='block';
});

backFromExisting.addEventListener('click',()=>{
  existingPanel.style.display='none';
  optSuggest.style.display='inline-flex';
});

function confirmPlant(plant){
  displayPlantInfo(plant);
  localStorage.setItem('plantName',plant.name);
  updateHomeButtons();
  showPage(monitor);
}

confirmSuggest.addEventListener('click',()=>{
  const name = suggestDropdown.value;
  if(!name) return alert('Select a plant.');
  const plant = plants.find(p=>p.name===name);
  if(plant) confirmPlant(plant);
});

confirmExisting.addEventListener('click',()=>{
  const name = searchPlant.value.trim();
  const plant = plants.find(p=>p.name.toLowerCase()===name.toLowerCase());
  if(!plant) return alert('This plant is not in our database yet');
  confirmPlant(plant);
});

setupBack.addEventListener('click',()=>showPage(home));

// --- Monitor Controls ---
waterNow.addEventListener('click',()=>alert('Watering plant...'));
autoMode.addEventListener('click',()=>{
  autoOn=!autoOn;
  autoMode.textContent = `Auto Mode: ${autoOn?'ON':'OFF'}`;
});

monitorBack.addEventListener('click',()=>showPage(home));
monitorClear.addEventListener('click',()=>{
  selectedPlant=null;
  localStorage.removeItem('plantName');
  updateHomeButtons();
  alert('Monitoring data cleared.');
  showPage(home);
});

// --- Sensor Updates ---
function updateSensors(){
  const temp = (15 + Math.random()*20).toFixed(1);
  const hum  = (40 + Math.random()*40).toFixed(1);
  const light= (2000 + Math.random()*8000).toFixed(0);
  const soil = (30 + Math.random()*70).toFixed(0);

  s_temp.textContent=temp;
  s_hum.textContent=hum;
  s_light.textContent=light;
  s_soil.textContent=soil;

  m_temp.textContent=temp;
  m_hum.textContent=hum;
  m_light.textContent=light;
  m_soil.textContent=soil;

  if(selectedPlant){
    healthAdvice.textContent = (temp<selectedPlant.tempMin||temp>selectedPlant.tempMax)?'⚠️ Temperature out of ideal range':'Temperature OK';
  } else {
    healthAdvice.textContent = 'Plant Health disabled';
  }
}

// --- Initialize ---
updateHomeButtons();
setInterval(updateSensors,2000);

// --- Load plant from localStorage if exists ---
if(localStorage.getItem('plantName')){
  const plant = plants.find(p=>p.name===localStorage.getItem('plantName'));
  if(plant) confirmPlant(plant);
}
