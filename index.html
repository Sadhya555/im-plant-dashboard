<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js
"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js
"></script>

<script>
  /*********** CONFIGURE THIS ************/
  const firebaseConfig = {
    apiKey: "AIzaSyA2lx9dz9n_U3yjGzedewfYx_zHRp-qKRY",
    authDomain: "im-plant-bracu.firebaseapp.com",
    databaseURL: "https://im-plant-bracu-default-rtdb.asia-southeast1.firebasedatabase.app
",
    projectId: "im-plant-bracu",
    storageBucket: "im-plant-bracu.firebasestorage.app",
    messagingSenderId: "1029559598764",
    appId: "1:1029559598764:web:4999edd794489312c1a909",
    measurementId: "G-C8PK5GDPD4"
  };
  /****************************************/

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --- UI helpers ---
  function goTo(page){
    document.getElementById('home').style.display = page==='home' ? 'block':'none';
    document.getElementById('setup').style.display = page==='setup' ? 'block':'none';
    document.getElementById('health').style.display = page==='health' ? 'block':'none';
  }

  const plants = ['Tomato','Mint','Spinach','Cactus','Rose','Basil','Chili','Lettuce'];
  const dd = document.getElementById('plantDropdown');
  plants.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;dd.appendChild(o);});

  // ----------------- Live sensor read -----------------
  let latestSensors = {temperature:null,humidity:null,light:null,soil:null};
  function readSensorsFromDB(){
    db.ref('garden').once('value').then(snap=>{
      const v = snap.val()||{};
      latestSensors.temperature = v.temperature ?? latestSensors.temperature;
      latestSensors.humidity = v.humidity ?? latestSensors.humidity;
      latestSensors.light = v.light ?? latestSensors.light;
      latestSensors.soil = v.soil ?? latestSensors.soil;
      updateSensorUI();
    }).catch(err=>console.error('readSensors',err));
  }

  function updateSensorUI(){
    document.getElementById('tempVal').textContent = latestSensors.temperature===null?'-- °C':latestSensors.temperature+' °C';
    document.getElementById('humVal').textContent = latestSensors.humidity===null?'-- %':latestSensors.humidity+' %';
    document.getElementById('lightVal').textContent = latestSensors.light===null?'-- lx':latestSensors.light+' lx';
    document.getElementById('moistVal').textContent = latestSensors.soil===null?'-- %':latestSensors.soil+' %';

    // Duplicate to health section
    document.getElementById('hTemp').textContent = document.getElementById('tempVal').textContent;
    document.getElementById('hHum').textContent = document.getElementById('humVal').textContent;
    document.getElementById('hLight').textContent = document.getElementById('lightVal').textContent;
    document.getElementById('hMoist').textContent = document.getElementById('moistVal').textContent;

    evaluateAdvice();
  }

  setInterval(readSensorsFromDB,5000);
  readSensorsFromDB();

  // ----------------- Plant selection & suggestion -----------------
  let currentSuggestions = [];
  let selectedSuggestion = null;

  function getSuggestions(){
    db.ref('garden').once('value').then(snap=>{
      const s = snap.val()||{};
      const temp=s.temperature??25, hum=s.humidity??50, light=s.light??300, soil=s.soil??50;
      currentSuggestions = suggestPlants(temp,hum,light,soil);
      renderSuggestions();
    });
  }

  function suggestPlants(temp,hum,light,soil){
    const candidates=[
      {name:'Tomato',ideal:{temp:[20,30],hum:[50,80],light:[400,10000],soil:[40,70]}},
      {name:'Mint',ideal:{temp:[15,28],hum:[50,90],light:[200,800],soil:[45,80]}},
      {name:'Spinach',ideal:{temp:[10,25],hum:[50,85],light:[200,600],soil:[50,80]}},
      {name:'Cactus',ideal:{temp:[20,40],hum:[0,40],light:[500,10000],soil:[0,30]}},
      {name:'Basil',ideal:{temp:[18,30],hum:[40,80],light:[300,900],soil:[40,70]}},
      {name:'Rose',ideal:{temp:[15,30],hum:[40,70],light:[400,10000],soil:[45,75]}}
    ];
    function score(p){
      const I=p.ideal;let s=0;
      if(temp>=I.temp[0]&&temp<=I.temp[1])s+=3;
      if(hum>=I.hum[0]&&hum<=I.hum[1])s+=2;
      if(light>=I.light[0]&&light<=I.light[1])s+=2;
      if(soil>=I.soil[0]&&soil<=I.soil[1])s+=3;
      return s;
    }
    const scored=candidates.map(c=>({name:c.name,score:score(c)})).sort((a,b)=>b.score-a.score);
    return scored.slice(0,3).map(s=>s.name);
  }

  function renderSuggestions(){
    const ul=document.getElementById('suggestions');ul.innerHTML='';
    currentSuggestions.forEach(name=>{
      const li=document.createElement('li');li.textContent=name;li.onclick=()=>selectSuggestion(name,li);ul.appendChild(li);
    });
    document.getElementById('suggestionConfirm').style.display='block';
  }

  function selectSuggestion(name,el){
    selectedSuggestion=name;
    document.querySelectorAll('#suggestions li').forEach(li=>li.style.borderColor='#e6eef9');
    el.style.borderColor='#2b8aef';
  }

  function confirmSelectedSuggestion(){
    if(!selectedSuggestion){alert('Select a plant first');return;}
    db.ref('selectedPlant').set(selectedSuggestion).then(()=>{
      log('Selected: '+selectedSuggestion);
      document.getElementById('selectedPlantDisplay').textContent=selectedSuggestion;
      document.getElementById('monitoredPlant').textContent=selectedSuggestion;
      goTo('health');
    });
  }

  // Already planted flow
  function filterPlants(){
    const q=document.getElementById('plantSearch').value.toLowerCase();
    const dd=document.getElementById('plantDropdown');dd.innerHTML='';
    plants.filter(p=>p.toLowerCase().includes(q)).forEach(p=>{
      const o=document.createElement('option');o.value=p;o.textContent=p;dd.appendChild(o);
    });
  }

  function confirmSelectedFromDropdown(){
    const val=document.getElementById('plantDropdown').value||document.getElementById('plantSearch').value;
    if(!val){alert('Select a plant');return;}
    db.ref('selectedPlant').set(val).then(()=>{
      log('Manual selection: '+val);
      document.getElementById('selectedPlantDisplay').textContent=val;
      document.getElementById('monitoredPlant').textContent=val;
      goTo('health');
    });
  }

  // ----------------- Advice -----------------
  function evaluateAdvice(){
    db.ref('selectedPlant').once('value').then(snap=>{
      const plant=snap.val();
      document.getElementById('monitoredPlant').textContent=plant||'--';
      if(!plant){document.getElementById('adviceBox').textContent='No plant selected.';return;}
      const t=latestSensors.temperature??0,h=latestSensors.humidity??0,l=latestSensors.light??0,m=latestSensors.soil??0;
      const adv=[];
      if(m<30)adv.push('Soil is dry — water the plant.');
      else if(m>85)adv.push('Soil moisture is high — wait before watering.');
      else adv.push('Soil moisture is good.');
      if(t<15)adv.push('Temperature is low — keep warmer.');
      else if(t>35)adv.push('Temperature high — provide shade.');
      if(l<200)adv.push('Low light — move to bright area.');
      else if(l>8000)adv.push('Too bright — partial shade.');
      if(h<30)adv.push('Low humidity — mist leaves.');
      document.getElementById('adviceBox').innerHTML=adv.map(a=>'• '+a).join('<br>');
    });
  }

  // ----------------- Pump control -----------------
  function manualWater(){
    db.ref('pump/status').set('ON').then(()=>log('Manual watering started.'));
    setTimeout(()=>db.ref('pump/status').set('OFF'),5000); // stop after 5s safety
  }

  function toggleAutoMode(enabled){
    db.ref('pump/autoMode').set(enabled).then(()=>log('Auto mode '+(enabled?'enabled':'disabled')));
  }

  db.ref('pump/status').on('value',snap=>{
    const s=snap.val()||'OFF';
    document.getElementById('pumpStatus').textContent=s.toUpperCase();
    log('Pump: '+s);
  });

  db.ref('selectedPlant').on('value',snap=>{
    const p=snap.val();
    document.getElementById('selectedPlantDisplay').textContent=p||'No plant selected';
    document.getElementById('monitoredPlant').textContent=p||'--';
  });

  function log(msg){
    const box=document.getElementById('logBox');
    const line=document.createElement('div');
    line.textContent=new Date().toLocaleTimeString()+' — '+msg;
    box.prepend(line);
  }

  goTo('home');
  filterPlants();
</script>
